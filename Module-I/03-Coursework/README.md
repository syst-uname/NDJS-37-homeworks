## Курсовой проект «NDSE: настройка окружения и Express.js»

### 1. Запуск 

#### 1.1 Старт

Образ приложения опубликованы на [hub.docker.com](https://hub.docker.com/repository/docker/u0name/coursework-avito/general)

Для запуска приложения стоит использовать команду 
```
docker compose up
```

Содержимое файла `docker-compose.yml`:
```
services:

  storage_mongo:
    image: mongo 
    ports:
      - 27017:27017
    environment:
      MONGO_INITDB_DATABASE: avito
    volumes:
      - ./src/db/init-db.js:/docker-entrypoint-initdb.d/init-db.js:ro 

  avito:
    image: u0name/coursework-avito:1.0.0
    ports: 
      - 80:${PORT}
    environment: 
      - MONGO_URL=mongodb://storage_mongo:27017/avito
    env_file:
      - .env
    depends_on: 
      - storage_mongo 
``` 


#### 1.2 Предварительные данные  

При старте сервиса в БД создаются предварительные тестовые данные с помощью скрипта `./src/db/init-db.js` 
Создаются следующие данные: 

* Пользователи: 
  * _id: `66ce2fd1ff15b0a9a9190001`, имя: `JohnDoe@gmail.com`, пароль: `JD`
  * _id: `66ce2fd1ff15b0a9a9190002`, имя: `BadComedian@mail.ru`, пароль: `BadComedian`
  * _id: `66ce2fd1ff15b0a9a9190003`, имя: `admin@avito.ru`, пароль: `Admin`

* Объявления:
  * _id: `66cba528b7e526c34cb00101`, Продажа Лада 2106
  * _id: `66cba528b7e526c34cb00102`, Сдается квартира
  * _id: `66cba528b7e526c34cb00103`, Продажа велосипеда 

* Чаты:
  * _id: `66d086d007ef0a7dd6c00301`, между пользователями `JohnDoe@gmail.com` (`66ce2fd1ff15b0a9a9190001`) и `BadComedian@mail.ru` (`66ce2fd1ff15b0a9a9190002`) с некоторым набором сообщений.


Id тестовых пользователей, объявлений и чатов жестко указываются в БД (только для тестовых данных) потому что созданные объекты будут далее ссылаться друг на друга и иметь ссылку и коллекциях postman для тестирования.  


#### 1.3. Тестирование 

Далее будут перечислены данные и результаты тестирования работы сервиса с помощью postman. Все тестируемые ниже запросы выложены в общедоступную коллекцию [Coursework-Avito](https://coursework-avito.postman.co/workspace/Coursework-Avito-Workspace~0b9be017-cfad-461e-aadb-36a70da84fc5/collection/22650945-2132b11c-a62c-45ec-8402-0ae4937052c4?action=share&creator=22650945) в postman. Некоторые id (все, кроме заданных заранее) при повторном тесте (т.е. при повторном запуске приложения) нужно будет соответственно заменять на новые значения. 


### 2. Модуль «Пользователи»

#### 2.1. Регистрация 

Запрос `POST` на `http://localhost/api/user/signup`


##### Указаны не все поля для регистрации 

Тело запроса (отсутствует имя): 
```
{
  "email": "IvanIvanov@mail.ru",
  "password": "ИИ",
  "contactPhone": "+7 123 456 78 90"
}
```
Результат (http-статус `400`): 
```
{
    "error": "Ошибка при регистрации IvanIvanov@mail.ru: User validation failed: name: Path `name` is required.",
    "status": "error"
}
```


##### Пароль слишком короткий

Тело запроса (пароль должен быть минимум 2 символа): 
```
{
  "email": "IvanIvanov@mail.ru",
  "password": "И",
  "name": "Иван Иванов",
  "contactPhone": "+7 123 456 78 90"
}
```

Результат (http-статус `400`): 
```
{
    "error": "Пароль слишком короткий",
    "status": "error"
}
```


##### Неверный формат email

Тело запроса (пропущен символ @): 
```
{
  "email": "IvanIvanovmail.ru",
  "password": "ИИ",
  "name": "Иван Иванов",
  "contactPhone": "+7 123 456 78 90"
}
```

Результат (http-статус `500`): 
```
{
    "error": "Ошибка при регистрации IvanIvanovmail.ru: User validation failed: email: Некорректный email",
    "status": "error"
}
```


##### Неверный формат телефона

Тело запроса (текст в номере телефона): 
```
{
  "email": "IvanIvanov@mail.ru",
  "password": "ИИ",
  "name": "Иван Иванов",
  "contactPhone": "+7 123 456 ab cd"
}
```

Результат (http-статус `500`): 
```
{
    "error": "Ошибка при регистрации IvanIvanov@mail.ru: User validation failed: contactPhone: Некорректный номер телефона",
    "status": "error"
}
```


##### Пользователь уже зарегистрирован  

Тело запроса (email уже занят): 
```
{
  "email": "JohnDoe@gmail.com",
  "password": "ИИ",
  "name": "Иван Иванов",
  "contactPhone": "+7 123 456 78 90"
}
```
Результат (http-статус `400`): 
```
{
    "error": "Пользователь с таким email уже зарегистрирован",
    "status": "error"
}
```


##### Корректные данные

Тело запроса: 
```
{
  "email": "IvanIvanov@mail.ru",
  "password": "ИИ",
  "name": "Иван Иванов",
  "contactPhone": "+7 123 456 78 90"
}
```

Результат (http-статус `201`): 
```
{
    "data": {
        "_id": "66d8422b557da6bae96c67f3",
        "email": "IvanIvanov@mail.ru",
        "name": "Иван Иванов",
        "contactPhone": "+7 123 456 78 90"
    },
    "status": "ok"
}
```
При успешной регистрации данные пользователя сохраняются в БД, присваивается уникальный id (уже произвольный). Пароль сохраняется в захешированном виде.
Результат записи в БД данных для `IvanIvanov@mail.ru`: 
```
{
  "_id": {
    "$oid": "66d8422b557da6bae96c67f3"
  },
  "email": "IvanIvanov@mail.ru",
  "passwordHash": "$2b$10$9ym1/QbLRlbyO3L23kVOeuO1VamYzA/qdU/mn6IRForOrWu4wNKP.",
  "name": "Иван Иванов",
  "contactPhone": "+7 123 456 78 90",
  "__v": 0
}
```

#### 2.2. Аутентификация

Запрос `POST` на `http://localhost/api/user/signin`


##### Указаны не все поля для входа

Тело запроса (не указан пароль): 
```
{
  "email": "IvanIvanov@mail.ru"
}
```

Результат (http-статус `400`): 
```
{
    "error": "Missing credentials",
    "status": "error"
}
```


##### Пользователь не зарегистрирован

Тело запроса (ошибка в email): 
```
{
  "email": "InvalidIvanIvanov@mail.ru",
  "password": "ИИ"
}
```

Результат (http-статус `400`): 
```
{
    "error": "Неверный логин или пароль",
    "status": "error"
}
```


##### Неверный пароль

Тело запроса (ошибка в пароле): 
```
{
  "email": "IvanIvanov@mail.ru",
  "password": "ИИ_invalid"
}
```

Результат (http-статус `400`): 
```
{
    "error": "Неверный логин или пароль",
    "status": "error"
}
```

##### Корректные данные

Тело запроса: 
```
{
  "email": "IvanIvanov@mail.ru",
  "password": "ИИ"
}
```

Результат (http-статус `200`): 
```
{
    "data": {
        "_id": "66d8422b557da6bae96c67f3",
        "email": "IvanIvanov@mail.ru",
        "name": "Иван Иванов",
        "contactPhone": "+7 123 456 78 90"
    },
    "status": "ok"
}
```

Id пользователя совпадает с полученным при регистрации id (`66d8422b557da6bae96c67f3`).


#### 2.3. Выход 

Запрос `POST` на `http://localhost/api/user/logout`

Результат (http-статус `200`): 
```
{
    "message": "Вы вышли из системы",
    "status": "ok"
}
```


### 3. Модуль «Объявления»

#### 3.1. Создание объявления 

Запрос `POST` на `http://localhost/api/advertisement`


##### Пользователь еще не аутентифицирован 

Проверяется после выполнения выхода в п. 2.3. с любым телом запроса.

Результат (http-статус `401`): 
```
{
    "error": "Unauthorized",
    "status": "error"
}
```


##### Корректные данные

Предварительно произведена аутентификация пользователя (например `IvanIvanov@mail.ru`) как в п. 2.2. 

Тело запроса (в формате `form-data`): 
```
shortText:Скейтборд
description:Скейтборд ridex длина 80см, ширина 20см. Состояние новый, катался один раз
tags:Отдых, Доска
```

Результат (http-статус `201`): 
```
{
    "data": {
        "_id": "66d85a90557da6bae96c680b",
        "shortText": "Скейтборд",
        "description": "Скейтборд ridex длина 80см, ширина 20см. Состояние новый, катался один раз",
        "images": [],
        "user": {
            "_id": "66d8422b557da6bae96c67f3",
            "name": "Иван Иванов"
        },
        "createdAt": "2024-09-04T13:03:12.775Z",
        "tags": [
            "Отдых",
            "Доска"
        ]
    },
    "status": "ok"
}
```
При успешном создании данные сохраняются в БД, объявлению присваивается уникальный id. Id пользователя определяется по данным аутентификации (id совпадает с полученным при регистрации `66d8422b557da6bae96c67f3`).
Данные непосредственно в БД выглядят следующим образом: 
```
{
  "_id": {
    "$oid": "66d85a90557da6bae96c680b"
  },
  "shortText": "Скейтборд",
  "description": "Скейтборд ridex длина 80см, ширина 20см. Состояние новый, катался один раз",
  "images": [],
  "userId": {
    "$oid": "66d8422b557da6bae96c67f3"
  },
  "tags": [
    "Отдых",
    "Доска"
  ],
  "isDeleted": false,
  "createdAt": {
    "$date": "2024-09-04T13:03:12.775Z"
  },
  "__v": 0
}
```


##### Корректные данные (tags как массив)

В пункте выше данные в параметре tags передавались через запятую. Есть возможность передать их сразу в виде массива в теле запроса. 
Тело запроса (в формате `form-data`): 
```
shortText:Скейтборд
description:Скейтборд ridex длина 80см, ширина 20см. Состояние новый, катался один раз
tags:Отдых
tags:Доска
tags:Покатушки
```

Результат (http-статус `201`): 
```
{
    "data": {
        "_id": "66d85c68557da6bae96c6810",
        "shortText": "Скейтборд",
        "description": "Скейтборд ridex длина 80см, ширина 20см. Состояние новый, катался один раз",
        "images": [],
        "user": {
            "_id": "66d8422b557da6bae96c67f3",
            "name": "Иван Иванов"
        },
        "createdAt": "2024-09-04T13:11:04.808Z",
        "tags": [
            "Отдых",
            "Доска",
            "Покатушки"
        ]
    },
    "status": "ok"
}
```
Сгенерировался следующий номер объявления, id пользователя все еще тот же (`66d8422b557da6bae96c67f3` для `IvanIvanov@mail.ru`)

##### Корректные данные (с файлами)

Тело запроса (в формате `form-data`): 
```
shortText:Скейтборд
description:Скейтборд ridex длина 80см, ширина 20см. Состояние новый, катался один раз
images: [выбраны 3 файла jpg]
tags:Отдых, Доска, Покатушки
```
Файлы для поля images (тип File) прикрепляются в postman с локального диска. 
Все файлы для тестовых примеров доступны в папке `./src/storage/mock`

Результат (http-статус `201`): 
```
{
    "data": {
        "_id": "66d85e1f557da6bae96c6815",
        "shortText": "Скейтборд",
        "description": "Скейтборд ridex длина 80см, ширина 20см. Состояние новый, катался один раз",
        "images": [
            "src/storage/uploads/66d85e1f557da6bae96c6815/Скейтборд 1.jpg",
            "src/storage/uploads/66d85e1f557da6bae96c6815/Скейтборд 2.jpg",
            "src/storage/uploads/66d85e1f557da6bae96c6815/Скейтборд 3.jpg"
        ],
        "user": {
            "_id": "66d8422b557da6bae96c67f3",
            "name": "Иван Иванов"
        },
        "createdAt": "2024-09-04T13:18:23.697Z",
        "tags": [
            "Отдых",
            "Доска",
            "Покатушки"
        ]
    },
    "status": "ok"
}
```

Для всех файлов загруженных при создании объявления в папке `src/storage/uploads` создается подпапка с id объявления в названии (в данном случае подпапка `66d85e1f557da6bae96c6815`) куда и складываются все прикрепленный фалы.
Результат проверки наличия файлов в контейнере c приложения (где `66d85e1f557da6bae96c6815` - id только что созданного объявления): 
```
/app # ls src/storage/uploads/66d85e1f557da6bae96c6815
Скейтборд 1.jpg  Скейтборд 2.jpg  Скейтборд 3.jpg
```  


#### 3.2. Удаление

##### Объявления нет

Запрос `DELETE` на `http://localhost:3002/api/advertisement/66cba528b7e526c34cb60000`

Id объявление передается в query-параметрах запроса (объявления с id `66cba528b7e526c34cb60000` не существует).

Результат (http-статус `404`): 
```
{
    "error": "Ошибка при удалении объявления 66cba528b7e526c34cb60000: объявление не найдено",
    "status": "error"
}
```


##### Удаление чужого объявления

Запрос `DELETE` на `http://localhost/api/advertisement/66cba528b7e526c34cb00102`

Где `66cba528b7e526c34cb00102` - id объявления созданного пользователем `BadComedian@mail.ru`.
Предварительно произведена аутентификация под пользователем `IvanIvanov@mail.ru`.

Результат (http-статус `403`): 
```
{
    "error": "Ошибка при удалении объявления 66cba528b7e526c34cb00102: недостаточно прав",
    "status": "error"
}
```


##### Корректные данные

Запрос `DELETE` на `http://localhost:3002/api/advertisement/66d85a90557da6bae96c680b`

Где `66d85a90557da6bae96c680b` - id созданного ранее объявления под пользователем `IvanIvanov@mail.ru`.

Результат (http-статус `200`): 
```
{
    "message": "Объявление 66d85a90557da6bae96c680b удалено",
    "status": "ok"
}
```
При этом данные в БД:
```
{
  "_id": {
    "$oid": "66d85a90557da6bae96c680b"
  },
  "shortText": "Скейтборд",
  "description": "Скейтборд ridex длина 80см, ширина 20см. Состояние новый, катался один раз",
  "images": [],
  "userId": {
    "$oid": "66d8422b557da6bae96c67f3"
  },
  "tags": [
    "Отдых",
    "Доска"
  ],
  "isDeleted": true,
  "createdAt": {
    "$date": "2024-09-04T13:03:12.775Z"
  },
  "__v": 0
}
```
Флаг `isDeleted` принял значение `true`, данные объявления и файлы (если бы такие были) остались на месте. 



#### 3.3. Просмотр


##### Объявление уже удалено

Запрос `GET` на `http://localhost:3002/api/advertisement/66d85a90557da6bae96c680b`

Где `66d85a90557da6bae96c680b` - удаленное в п.3.2 объявление.

Результат (http-статус `410`): 
```
{
    "error": "Ошибка при получении объявления 66d85a90557da6bae96c680b: объявление удалено",
    "status": "error"
}
```


##### Корректные данные

Запрос `GET` на `http://localhost/api/advertisement/66d85e1f557da6bae96c6815`

Где `66d85e1f557da6bae96c6815` - id созданного в п.3.1 объявления. 

Результат (http-статус `200`): 
```
{
    "data": {
        "_id": "66d85e1f557da6bae96c6815",
        "shortText": "Скейтборд",
        "description": "Скейтборд ridex длина 80см, ширина 20см. Состояние новый, катался один раз",
        "images": [
            "src/storage/uploads/66d85e1f557da6bae96c6815/Скейтборд 1.jpg",
            "src/storage/uploads/66d85e1f557da6bae96c6815/Скейтборд 2.jpg",
            "src/storage/uploads/66d85e1f557da6bae96c6815/Скейтборд 3.jpg"
        ],
        "user": {
            "_id": "66d8422b557da6bae96c67f3",
            "name": "Иван Иванов"
        },
        "createdAt": "2024-09-04T13:18:23.697Z",
        "tags": [
            "Отдых",
            "Доска",
            "Покатушки"
        ]
    },
    "status": "ok"
}
```


##### Все объявления 

Запрос `GET` на `http://localhost/api/advertisement`

Результат (http-статус `200`): 
```
{
    "data": [
        {
            "_id": "66cba528b7e526c34cb00101",
            "shortText": "Продажа Лада 2106",
            "description": "В хорошем состоянии. За машиной ухаживали, все вовремя менялось. Двигатель после кап ремонта проехали 13000. Масло не ест совсем. Пороги меняны, гнили нет. Стоят заводские электроподъемники передних стекол. Музыка.",
            "images": [
                "src\\storage\\uploads\\66cba528b7e526c34cb00101\\Ваз-2106-двигатель.jpg",
                "src\\storage\\uploads\\66cba528b7e526c34cb00101\\Ваз-2106-кузов.jpg",
                "src\\storage\\uploads\\66cba528b7e526c34cb00101\\Ваз-2106-салон.jpg"
            ],
            "user": {
                "_id": "66ce2fd1ff15b0a9a9190001",
                "name": "John Doe"
            },
            "createdAt": "2024-09-04T10:14:39.157Z",
            "tags": [
                "Авто",
                "Лада",
                "2106"
            ]
        },
        {
            "_id": "66cba528b7e526c34cb00102",
            "shortText": "Сдается квартира",
            "description": "Сдается уютная квартира c индивидуальным отоплением. Для проживания есть все необходимое: мебель, техника.Рассматриваем платежеспособных, добропорядочных людей без домашних животных.",
            "images": [
                "src\\storage\\uploads\\66cba528b7e526c34cb00102\\Кухня.jpg",
                "src\\storage\\uploads\\66cba528b7e526c34cb00102\\Ванная комната.jpg"
            ],
            "user": {
                "_id": "66ce2fd1ff15b0a9a9190002",
                "name": "Евгений Баженов"
            },
            "createdAt": "2024-09-04T10:14:39.157Z",
            "tags": [
                "Квартира",
                "Аренда"
            ]
        },
        {
            "_id": "66cba528b7e526c34cb00103",
            "shortText": "Продажа велосипеда",
            "description": "Продается велосипед GT aggressor comp 27,5 S Гoд покупки: 2019, катались крайне мало, велосипед технически в идеальном состоянии",
            "images": [
                "src\\storage\\uploads\\66cba528b7e526c34cb00103\\Ваз-2106-двигатель.jpg",
                "src\\storage\\uploads\\66cba528b7e526c34cb00103\\Ваз-2106-кузов.jpg",
                "src\\storage\\uploads\\66cba528b7e526c34cb00103\\Ваз-2106-салон.jpg"
            ],
            "user": {
                "_id": "66ce2fd1ff15b0a9a9190002",
                "name": "Евгений Баженов"
            },
            "createdAt": "2024-09-04T10:14:39.157Z",
            "tags": [
                "Покатушки",
                "GT",
                "27,5"
            ]
        },
        {
            "_id": "66d85c68557da6bae96c6810",
            "shortText": "Скейтборд",
            "description": "Скейтборд ridex длина 80см, ширина 20см. Состояние новый, катался один раз",
            "images": [],
            "user": {
                "_id": "66d8422b557da6bae96c67f3",
                "name": "Иван Иванов"
            },
            "createdAt": "2024-09-04T13:11:04.808Z",
            "tags": [
                "Отдых",
                "Доска",
                "Покатушки"
            ]
        },
        {
            "_id": "66d85e1f557da6bae96c6815",
            "shortText": "Скейтборд",
            "description": "Скейтборд ridex длина 80см, ширина 20см. Состояние новый, катался один раз",
            "images": [
                "src/storage/uploads/66d85e1f557da6bae96c6815/Скейтборд 1.jpg",
                "src/storage/uploads/66d85e1f557da6bae96c6815/Скейтборд 2.jpg",
                "src/storage/uploads/66d85e1f557da6bae96c6815/Скейтборд 3.jpg"
            ],
            "user": {
                "_id": "66d8422b557da6bae96c67f3",
                "name": "Иван Иванов"
            },
            "createdAt": "2024-09-04T13:18:23.697Z",
            "tags": [
                "Отдых",
                "Доска",
                "Покатушки"
            ]
        }
    ],
    "status": "ok"
}
```

Перечисленные все объявления: 3 исходные тестовые и 2 оставшиеся созданные в процессе тестирования. Помеченные флагом удаления объявления не выводятся (`66d85a90557da6bae96c680b` из п.3.2).


#### 3.4. Поиск

##### По userId (John Doe)

Запрос `GET` на `http://localhost/api/advertisement?userId=66ce2fd1ff15b0a9a9190001`

Где `66ce2fd1ff15b0a9a9190001` - id пользователя `JohnDoe@gmail.com`

Результат (http-статус `200`): 
```
{
    "data": [
        {
            "_id": "66cba528b7e526c34cb00101",
            "shortText": "Продажа Лада 2106",
            "description": "В хорошем состоянии. За машиной ухаживали, все вовремя менялось. Двигатель после кап ремонта проехали 13000. Масло не ест совсем. Пороги меняны, гнили нет. Стоят заводские электроподъемники передних стекол. Музыка.",
            "images": [
                "src\\storage\\uploads\\66cba528b7e526c34cb00101\\Ваз-2106-двигатель.jpg",
                "src\\storage\\uploads\\66cba528b7e526c34cb00101\\Ваз-2106-кузов.jpg",
                "src\\storage\\uploads\\66cba528b7e526c34cb00101\\Ваз-2106-салон.jpg"
            ],
            "user": {
                "_id": "66ce2fd1ff15b0a9a9190001",
                "name": "John Doe"
            },
            "createdAt": "2024-09-04T10:14:39.157Z",
            "tags": [
                "Авто",
                "Лада",
                "2106"
            ]
        }
    ],
    "status": "ok"
}
```

Выводятся все объявления для пользователя `JohnDoe@gmail.com` (только одно). 
Это подготовленные тестовые данные. 


##### По userId (IvanIvanov)

Запрос `GET` на `http://localhost/api/advertisement?userId=66d8422b557da6bae96c67f3`

Где `66d8422b557da6bae96c67f3` - id созданного пользователя `IvanIvanov@mail.ru`
 
Результат (http-статус `200`): 
```
{
    "data": [
        {
            "_id": "66d85c68557da6bae96c6810",
            "shortText": "Скейтборд",
            "description": "Скейтборд ridex длина 80см, ширина 20см. Состояние новый, катался один раз",
            "images": [],
            "user": {
                "_id": "66d8422b557da6bae96c67f3",
                "name": "Иван Иванов"
            },
            "createdAt": "2024-09-04T13:11:04.808Z",
            "tags": [
                "Отдых",
                "Доска",
                "Покатушки"
            ]
        },
        {
            "_id": "66d85e1f557da6bae96c6815",
            "shortText": "Скейтборд",
            "description": "Скейтборд ridex длина 80см, ширина 20см. Состояние новый, катался один раз",
            "images": [
                "src/storage/uploads/66d85e1f557da6bae96c6815/Скейтборд 1.jpg",
                "src/storage/uploads/66d85e1f557da6bae96c6815/Скейтборд 2.jpg",
                "src/storage/uploads/66d85e1f557da6bae96c6815/Скейтборд 3.jpg"
            ],
            "user": {
                "_id": "66d8422b557da6bae96c67f3",
                "name": "Иван Иванов"
            },
            "createdAt": "2024-09-04T13:18:23.697Z",
            "tags": [
                "Отдых",
                "Доска",
                "Покатушки"
            ]
        }
    ],
    "status": "ok"
}
```

Выводятся два объявления пользователя `IvanIvanov@mail.ru` (без удаленных).
Это созданные в результате текущего тестирования данные. 

##### По userId (объявлений нет)

Запрос `GET` на `http://localhost/api/advertisement?userId=66ce2fd1ff15b0a9a9190003`

Где `66ce2fd1ff15b0a9a9190003` - id пользователя `admin@avito.ru` у которого нет объявлений
 

Результат (http-статус `200`): 
```
{
    "data": [],
    "status": "ok"
}
```


##### По shortText ("продажа")

Запрос `GET` на `http://localhost/api/advertisement?shortText=продажа`

Параметры поиска передаются через query.

Результат (http-статус `200`): 
```
{
    "data": [
        {
            "_id": "66cba528b7e526c34cb00101",
            "shortText": "Продажа Лада 2106",
            "description": "В хорошем состоянии. За машиной ухаживали, все вовремя менялось. Двигатель после кап ремонта проехали 13000. Масло не ест совсем. Пороги меняны, гнили нет. Стоят заводские электроподъемники передних стекол. Музыка.",
            "images": [
                "src\\storage\\uploads\\66cba528b7e526c34cb00101\\Ваз-2106-двигатель.jpg",
                "src\\storage\\uploads\\66cba528b7e526c34cb00101\\Ваз-2106-кузов.jpg",
                "src\\storage\\uploads\\66cba528b7e526c34cb00101\\Ваз-2106-салон.jpg"
            ],
            "user": {
                "_id": "66ce2fd1ff15b0a9a9190001",
                "name": "John Doe"
            },
            "createdAt": "2024-09-04T10:14:39.157Z",
            "tags": [
                "Авто",
                "Лада",
                "2106"
            ]
        },
        {
            "_id": "66cba528b7e526c34cb00103",
            "shortText": "Продажа велосипеда",
            "description": "Продается велосипед GT aggressor comp 27,5 S Гoд покупки: 2019, катались крайне мало, велосипед технически в идеальном состоянии",
            "images": [
                "src\\storage\\uploads\\66cba528b7e526c34cb00103\\Ваз-2106-двигатель.jpg",
                "src\\storage\\uploads\\66cba528b7e526c34cb00103\\Ваз-2106-кузов.jpg",
                "src\\storage\\uploads\\66cba528b7e526c34cb00103\\Ваз-2106-салон.jpg"
            ],
            "user": {
                "_id": "66ce2fd1ff15b0a9a9190002",
                "name": "Евгений Баженов"
            },
            "createdAt": "2024-09-04T10:14:39.157Z",
            "tags": [
                "Покатушки",
                "GT",
                "27,5"
            ]
        }
    ],
    "status": "ok"
}
```

Выводятся объявления с тестом *продажа* в заголовке (только 1 и 3 объявления). 


##### По shortText ("кварт")

Запрос `GET` на `http://localhost/api/advertisement?shortText=кварт`

Результат (http-статус `200`): 
```
{
    "data": [
        {
            "_id": "66cba528b7e526c34cb00102",
            "shortText": "Сдается квартира",
            "description": "Сдается уютная квартира c индивидуальным отоплением. Для проживания есть все необходимое: мебель, техника.Рассматриваем платежеспособных, добропорядочных людей без домашних животных.",
            "images": [
                "src\\storage\\uploads\\66cba528b7e526c34cb00102\\Кухня.jpg",
                "src\\storage\\uploads\\66cba528b7e526c34cb00102\\Ванная комната.jpg"
            ],
            "user": {
                "_id": "66ce2fd1ff15b0a9a9190002",
                "name": "Евгений Баженов"
            },
            "createdAt": "2024-09-04T10:14:39.157Z",
            "tags": [
                "Квартира",
                "Аренда"
            ]
        }
    ],
    "status": "ok"
}
```

Нашлось объявление о сдаче *кварт*иры


##### По description ("все")

Запрос `GET` на `http://localhost/api/advertisement?description=все`

Результат (http-статус `200`): 
```
{
    "data": [
        {
            "_id": "66cba528b7e526c34cb00101",
            "shortText": "Продажа Лада 2106",
            "description": "В хорошем состоянии. За машиной ухаживали, все вовремя менялось. Двигатель после кап ремонта проехали 13000. Масло не ест совсем. Пороги меняны, гнили нет. Стоят заводские электроподъемники передних стекол. Музыка.",
            "images": [
                "src\\storage\\uploads\\66cba528b7e526c34cb00101\\Ваз-2106-двигатель.jpg",
                "src\\storage\\uploads\\66cba528b7e526c34cb00101\\Ваз-2106-кузов.jpg",
                "src\\storage\\uploads\\66cba528b7e526c34cb00101\\Ваз-2106-салон.jpg"
            ],
            "user": {
                "_id": "66ce2fd1ff15b0a9a9190001",
                "name": "John Doe"
            },
            "createdAt": "2024-09-04T10:14:39.157Z",
            "tags": [
                "Авто",
                "Лада",
                "2106"
            ]
        },
        {
            "_id": "66cba528b7e526c34cb00102",
            "shortText": "Сдается квартира",
            "description": "Сдается уютная квартира c индивидуальным отоплением. Для проживания есть все необходимое: мебель, техника.Рассматриваем платежеспособных, добропорядочных людей без домашних животных.",
            "images": [
                "src\\storage\\uploads\\66cba528b7e526c34cb00102\\Кухня.jpg",
                "src\\storage\\uploads\\66cba528b7e526c34cb00102\\Ванная комната.jpg"
            ],
            "user": {
                "_id": "66ce2fd1ff15b0a9a9190002",
                "name": "Евгений Баженов"
            },
            "createdAt": "2024-09-04T10:14:39.157Z",
            "tags": [
                "Квартира",
                "Аренда"
            ]
        }
    ],
    "status": "ok"
}
```

Нашлись объявления с текстом *все* в подробном описании.


##### По shortText и description ("прод","все")

Запрос `GET` на `http://localhost/api/advertisement?shortText=прод&description=все`

Результат (http-статус `200`): 
```
{
    "data": [
        {
            "_id": "66cba528b7e526c34cb00101",
            "shortText": "Продажа Лада 2106",
            "description": "В хорошем состоянии. За машиной ухаживали, все вовремя менялось. Двигатель после кап ремонта проехали 13000. Масло не ест совсем. Пороги меняны, гнили нет. Стоят заводские электроподъемники передних стекол. Музыка.",
            "images": [
                "src\\storage\\uploads\\66cba528b7e526c34cb00101\\Ваз-2106-двигатель.jpg",
                "src\\storage\\uploads\\66cba528b7e526c34cb00101\\Ваз-2106-кузов.jpg",
                "src\\storage\\uploads\\66cba528b7e526c34cb00101\\Ваз-2106-салон.jpg"
            ],
            "user": {
                "_id": "66ce2fd1ff15b0a9a9190001",
                "name": "John Doe"
            },
            "createdAt": "2024-09-04T10:14:39.157Z",
            "tags": [
                "Авто",
                "Лада",
                "2106"
            ]
        }
    ],
    "status": "ok"
}
```

Найдено объявление где одновременно встречается текст *прод* в заголовке и текст *все* в описании 

##### По shortText - нет данных 

Запрос `GET` на `http://localhost/api/advertisement?shortText=invalid` 

Результат (http-статус `200`): 
```
{
    "data": [],
    "status": "ok"
}
```
Подобный данных нет.


##### По tags ("Покатушки")

Запрос `GET` на `http://localhost/api/advertisement?tags=Покатушки`

Результат (http-статус `200`): 
```
{
    "data": [
        {
            "_id": "66cba528b7e526c34cb00103",
            "shortText": "Продажа велосипеда",
            "description": "Продается велосипед GT aggressor comp 27,5 S Гoд покупки: 2019, катались крайне мало, велосипед технически в идеальном состоянии",
            "images": [
                "src\\storage\\uploads\\66cba528b7e526c34cb00103\\Ваз-2106-двигатель.jpg",
                "src\\storage\\uploads\\66cba528b7e526c34cb00103\\Ваз-2106-кузов.jpg",
                "src\\storage\\uploads\\66cba528b7e526c34cb00103\\Ваз-2106-салон.jpg"
            ],
            "user": {
                "_id": "66ce2fd1ff15b0a9a9190002",
                "name": "Евгений Баженов"
            },
            "createdAt": "2024-09-04T10:14:39.157Z",
            "tags": [
                "Покатушки",
                "GT",
                "27,5"
            ]
        },
        {
            "_id": "66d85c68557da6bae96c6810",
            "shortText": "Скейтборд",
            "description": "Скейтборд ridex длина 80см, ширина 20см. Состояние новый, катался один раз",
            "images": [],
            "user": {
                "_id": "66d8422b557da6bae96c67f3",
                "name": "Иван Иванов"
            },
            "createdAt": "2024-09-04T13:11:04.808Z",
            "tags": [
                "Отдых",
                "Доска",
                "Покатушки"
            ]
        },
        {
            "_id": "66d85e1f557da6bae96c6815",
            "shortText": "Скейтборд",
            "description": "Скейтборд ridex длина 80см, ширина 20см. Состояние новый, катался один раз",
            "images": [
                "src/storage/uploads/66d85e1f557da6bae96c6815/Скейтборд 1.jpg",
                "src/storage/uploads/66d85e1f557da6bae96c6815/Скейтборд 2.jpg",
                "src/storage/uploads/66d85e1f557da6bae96c6815/Скейтборд 3.jpg"
            ],
            "user": {
                "_id": "66d8422b557da6bae96c67f3",
                "name": "Иван Иванов"
            },
            "createdAt": "2024-09-04T13:18:23.697Z",
            "tags": [
                "Отдых",
                "Доска",
                "Покатушки"
            ]
        }
    ],
    "status": "ok"
}
```

Найдены все объявления с тегом *Покатушки*

##### По tags ("Покатушки","GT") через запятую

Запрос `GET` на `http://localhost/api/advertisement?tags=Покатушки,GT`

Несколько значений параметра `tags` можно передавать через запятую. 

Результат (http-статус `200`): 
```
{
    "data": [
        {
            "_id": "66cba528b7e526c34cb00103",
            "shortText": "Продажа велосипеда",
            "description": "Продается велосипед GT aggressor comp 27,5 S Гoд покупки: 2019, катались крайне мало, велосипед технически в идеальном состоянии",
            "images": [
                "src\\storage\\uploads\\66cba528b7e526c34cb00103\\Ваз-2106-двигатель.jpg",
                "src\\storage\\uploads\\66cba528b7e526c34cb00103\\Ваз-2106-кузов.jpg",
                "src\\storage\\uploads\\66cba528b7e526c34cb00103\\Ваз-2106-салон.jpg"
            ],
            "user": {
                "_id": "66ce2fd1ff15b0a9a9190002",
                "name": "Евгений Баженов"
            },
            "createdAt": "2024-09-04T10:14:39.157Z",
            "tags": [
                "Покатушки",
                "GT",
                "27,5"
            ]
        }
    ],
    "status": "ok"
}
```

Найдено объявление где присутствуют оба тега. 

##### По tags ("Покатушки","GT") как массив

Запрос `GET` на `http://localhost:3002/api/advertisement?tags=Покатушки&tags=GT`

Несколько значений параметра `tags` можно передавать сразу как массив. 

Результат (http-статус `200`): 
```
{
    "data": [
        {
            "_id": "66cba528b7e526c34cb00103",
            "shortText": "Продажа велосипеда",
            "description": "Продается велосипед GT aggressor comp 27,5 S Гoд покупки: 2019, катались крайне мало, велосипед технически в идеальном состоянии",
            "images": [
                "src\\storage\\uploads\\66cba528b7e526c34cb00103\\Ваз-2106-двигатель.jpg",
                "src\\storage\\uploads\\66cba528b7e526c34cb00103\\Ваз-2106-кузов.jpg",
                "src\\storage\\uploads\\66cba528b7e526c34cb00103\\Ваз-2106-салон.jpg"
            ],
            "user": {
                "_id": "66ce2fd1ff15b0a9a9190002",
                "name": "Евгений Баженов"
            },
            "createdAt": "2024-09-04T10:14:39.157Z",
            "tags": [
                "Покатушки",
                "GT",
                "27,5"
            ]
        }
    ],
    "status": "ok"
}
```

Найдено тоже объявление. 

### 4. Модуль «Чат»

Хотя основная работа с чатом производиться через socket, для целей тестирования API чата были разработаны соответствующие роуты. 


#### 4.1. Получить чат между пользователями


##### По id users (JD и BadComedian)

Запрос `GET` на `http://localhost/api/chat?users=66ce2fd1ff15b0a9a9190001&users=66ce2fd1ff15b0a9a9190002`

Где в query передаются id соответствующих пользователей.  

Результат (http-статус `200`): 
```
{
    "data": {
        "_id": "66d086d007ef0a7dd6c00301",
        "users": [
            {
                "_id": "66ce2fd1ff15b0a9a9190001",
                "name": "John Doe"
            },
            {
                "_id": "66ce2fd1ff15b0a9a9190002",
                "name": "Евгений Баженов"
            }
        ],
        "createdAt": "2024-09-04T10:14:39.178Z",
        "messages": [
            {
                "_id": "66cf7f906931f1a335400201",
                "author": "66ce2fd1ff15b0a9a9190001",
                "sentAt": "2024-09-04T10:14:39.178Z",
                "text": "Добрый день! Какие тормоза на велосипеде?"
            },
            {
                "_id": "66cf7f906931f1a335400202",
                "author": "66ce2fd1ff15b0a9a9190002",
                "sentAt": "2024-09-04T10:14:39.179Z",
                "text": "Здравствуйте, гидравлические shimano mt200"
            },
            {
                "_id": "66cf7f906931f1a335400203",
                "author": "66ce2fd1ff15b0a9a9190001",
                "sentAt": "2024-09-04T10:14:39.179Z",
                "text": "Готов взять со скидкой"
            },
            {
                "_id": "66cf7f906931f1a335400204",
                "author": "66ce2fd1ff15b0a9a9190002",
                "sentAt": "2024-09-04T10:14:39.179Z",
                "text": "Приходите, обсудим"
            }
        ]
    },
    "status": "ok"
}
```

#### 4.2. Получить историю сообщений чата


##### По id чата 

Запрос `GET` на `http://localhost/api/chat/getHistory/66d086d007ef0a7dd6c00301`


Результат (http-статус `200`): 
```
{
    "data": [
        {
            "_id": "66cf7f906931f1a335400201",
            "author": "66ce2fd1ff15b0a9a9190001",
            "sentAt": "2024-09-04T10:14:39.178Z",
            "text": "Добрый день! Какие тормоза на велосипеде?"
        },
        {
            "_id": "66cf7f906931f1a335400202",
            "author": "66ce2fd1ff15b0a9a9190002",
            "sentAt": "2024-09-04T10:14:39.179Z",
            "text": "Здравствуйте, гидравлические shimano mt200"
        },
        {
            "_id": "66cf7f906931f1a335400203",
            "author": "66ce2fd1ff15b0a9a9190001",
            "sentAt": "2024-09-04T10:14:39.179Z",
            "text": "Готов взять со скидкой"
        },
        {
            "_id": "66cf7f906931f1a335400204",
            "author": "66ce2fd1ff15b0a9a9190002",
            "sentAt": "2024-09-04T10:14:39.179Z",
            "text": "Приходите, обсудим"
        }
    ],
    "status": "ok"
}
```
Аналогичный п. 4.1. результат, но выводится только массив сообщений. 


#### 4.3. Отправить сообщение

Запрос `POST` на `http://localhost/api/chat`

##### В существующий чат (JD, BadComedian) 

Тело запроса: 
```
{
    "author": "66ce2fd1ff15b0a9a9190001",
    "receiver": "66ce2fd1ff15b0a9a9190002",
    "text": "Адрес какой?"
}
```

Где в `author` и `receiver` указаны id соответствующих пользователей.  

Результат (http-статус `200`): 
```
{
    "data": {
        "author": "66ce2fd1ff15b0a9a9190001",
        "text": "Адрес какой?",
        "_id": "66d87fd9557da6bae96c6868",
        "sentAt": "2024-09-04T15:42:17.079Z"
    },
    "status": "ok"
}
```

Повторное чтение чата этих пользователей: 
Запрос `GET` на `http://localhost/api/chat?users=66ce2fd1ff15b0a9a9190001&users=66ce2fd1ff15b0a9a9190002`

Результат (http-статус `200`): 
```
{
    "data": {
        "_id": "66d086d007ef0a7dd6c00301",
        "users": [
            {
                "_id": "66ce2fd1ff15b0a9a9190001",
                "name": "John Doe"
            },
            {
                "_id": "66ce2fd1ff15b0a9a9190002",
                "name": "Евгений Баженов"
            }
        ],
        "createdAt": "2024-09-04T10:14:39.178Z",
        "messages": [
            {
                "_id": "66cf7f906931f1a335400201",
                "author": "66ce2fd1ff15b0a9a9190001",
                "sentAt": "2024-09-04T10:14:39.178Z",
                "text": "Добрый день! Какие тормоза на велосипеде?"
            },
            {
                "_id": "66cf7f906931f1a335400202",
                "author": "66ce2fd1ff15b0a9a9190002",
                "sentAt": "2024-09-04T10:14:39.179Z",
                "text": "Здравствуйте, гидравлические shimano mt200"
            },
            {
                "_id": "66cf7f906931f1a335400203",
                "author": "66ce2fd1ff15b0a9a9190001",
                "sentAt": "2024-09-04T10:14:39.179Z",
                "text": "Готов взять со скидкой"
            },
            {
                "_id": "66cf7f906931f1a335400204",
                "author": "66ce2fd1ff15b0a9a9190002",
                "sentAt": "2024-09-04T10:14:39.179Z",
                "text": "Приходите, обсудим"
            },
            {
                "author": "66ce2fd1ff15b0a9a9190001",
                "text": "Адрес какой?",
                "_id": "66d87fd9557da6bae96c6868",
                "sentAt": "2024-09-04T15:42:17.079Z"
            }
        ],
        "__v": 1
    },
    "status": "ok"
}
```

В истории появилось новое сообщение. 


##### В пустой чат (Admin, IvanIvanov) 

Тело запроса: 
```
{
    "author": "66ce2fd1ff15b0a9a9190003",
    "receiver": "66d8422b557da6bae96c67f3",
    "text": "Предлагаем вам скидку на продвижение ваших объявлений"
}
```

В поле `receiver` теперь указан id для `IvanIvanov@mail.ru`.

Результат (http-статус `200`): 
```
{
    "data": {
        "author": "66ce2fd1ff15b0a9a9190003",
        "text": "Предлагаем вам скидку на продвижение ваших объявлений",
        "_id": "66d88141557da6bae96c6870",
        "sentAt": "2024-09-04T15:48:17.298Z"
    },
    "status": "ok"
}
```

Проверка чата этих пользователей: 
Запрос `GET` на `http://localhost/api/chat?users=66ce2fd1ff15b0a9a9190003&users=66d8422b557da6bae96c67f3`

Результат: 
```
{
    "data": {
        "_id": "66d88141557da6bae96c686f",
        "users": [
            {
                "_id": "66ce2fd1ff15b0a9a9190003",
                "name": "Admin"
            },
            {
                "_id": "66d8422b557da6bae96c67f3",
                "name": "Иван Иванов"
            }
        ],
        "createdAt": "2024-09-04T15:48:17.298Z",
        "messages": [
            {
                "author": "66ce2fd1ff15b0a9a9190003",
                "text": "Предлагаем вам скидку на продвижение ваших объявлений",
                "_id": "66d88141557da6bae96c6870",
                "sentAt": "2024-09-04T15:48:17.298Z"
            }
        ],
        "__v": 0
    },
    "status": "ok"
}
```

В чате одно только что созданное сообщение. 


#### 4.4. Общение 

##### Отправка сообщений 

Для теста socket пришлось создать примитивные html-формы регистрации `./src/storage/public/signin.html` и формирования/отображения сообщений `./src/storage/public/chat.html`.  

Тестирование производится на трех пользователях, каждый в своем браузере (для сохранения данных аутентификации). В каждом браузере одна вкладка будет использоваться для аутентификации (`http://localhost/signin.html`), вторая для чата (`http://localhost/chat.html`)

Расположение окон следующее: 
* слева `JohnDoe@gmail.com`, id `66ce2fd1ff15b0a9a9190001` 
* справа `BadComedian@mail.ru`, id `66ce2fd1ff15b0a9a9190002` 
* снизу `IvanIvanov@mail.ru`, id `66d8422b557da6bae96c67f3`

![Аутентификация](src/storage/public/README/04.01%20Аутентификация.png)

Подтверждение входа в каждом из окон после аутентификации: 
![Аутентификация, вход](src/storage/public/README/04.02%20Аутентификация.%20После%20входа.png)

Теперь указываем кто с кем собирается чатиться. Для имитации общения с конкретным человеком придется использовать соответствующий id пользователя. Пусть левое (`JohnDoe@gmail.com`) и правое (`BadComedian@mail.ru`) окна общаются друг с другом. Для этого слева укажем в получателях id `66ce2fd1ff15b0a9a9190002` (это отсылка к `BadComedian@mail.ru`), а справа `66ce2fd1ff15b0a9a9190001` (`JohnDoe@gmail.com`). Окно снизу (`IvanIvanov@mail.ru`) пусть тоже общается с `BadComedian@mail.ru` (`66ce2fd1ff15b0a9a9190002`):

![Настройка чатов](src/storage/public/README/04.03%20Настройка%20чатов.png)

Пользователь `JohnDoe@gmail.com` (слева) пытается отправить текст `сообщение 1` к `BadComedian@mail.ru`, соответствующее поле ввода заполнено. 
Нажимаем `Отправить`:

![Сообщение 1](src/storage/public/README/04.04%20Сообщение%201.png)

Новое сообщение автоматически (без обновления страницы) отобразилось у пользователя `JohnDoe@gmail.com` (автор слева) и `BadComedian@mail.ru` (получатель справа). Диалог с `IvanIvanov@mail.ru` остается пуст.

Пусть `JohnDoe@gmail.com` снова отправит сообщение `BadComedian@mail.ru`. Вводим новый текст `второе сообщение` в соответствующее поле ввода (слева) и нажимаем `Отправить`: 

![Сообщение 2](src/storage/public/README/04.05%20Сообщение%202.png)

Новое сообщение снова появилось только в диалоге между `JohnDoe@gmail.com` и `BadComedian@mail.ru`, а чат с `IvanIvanov@mail.ru` остался пуст. 

Теперь `BadComedian@mail.ru` отправит сообщение `JohnDoe@gmail.com`. Вводим текст справа, нажимает `Отправить`: 
 
![Сообщение 3](src/storage/public/README/04.06%20Сообщение%203.png)

Сообщение отобразилось только у нужных пользователей, id автора последнего сообщения в списке сообщений соответствует `BadComedian@mail.ru` (`66ce2fd1ff15b0a9a9190002`). Чат `IvanIvanov@mail.ru` все также пуст.

Теперь `IvanIvanov@mail.ru` пишет `BadComedian@mail.ru` (окно снизу): 
![Сообщение 4](src/storage/public/README/04.07%20Сообщение%204.png)

Новое сообщение появилось только у `IvanIvanov@mail.ru` и `BadComedian@mail.ru`. Id автора (`66d8422b557da6bae96c67f3`) соответствует `IvanIvanov@mail.ru`.  


##### История сообщений 

Продолжаем тестировать на той же раскладке окон: 
* слева `JohnDoe@gmail.com`, id `66ce2fd1ff15b0a9a9190001`
* справа `BadComedian@mail.ru`, id `66ce2fd1ff15b0a9a9190002` 
* снизу `IvanIvanov@mail.ru`, id `66d8422b557da6bae96c67f3`

Только теперь меняем получателей: 
* слева у `JohnDoe@gmail.com` оставляем `66ce2fd1ff15b0a9a9190002`, это самая большая переписка между `JohnDoe@gmail.com` и `BadComedian@mail.ru` 
* справа у `BadComedian@mail.ru` указываем `66d8422b557da6bae96c67f3` (ссылка на `IvanIvanov@mail.ru` из нижнего окна) 
* снизу у `IvanIvanov@mail.ru` указываем `66ce2fd1ff15b0a9a9190001`, это `JohnDoe@gmail.com` и они вообще не общались друг с другом 

В каждом окне нажимаем кнопку `Получить историю чата`:

![История сообщений](src/storage/public/README/04.08%20История%20сообщений.png)

Слева появились все сообщения между `JohnDoe@gmail.com` и `BadComedian@mail.ru`. 
Справа только одно имеющееся сообщение между `BadComedian@mail.ru` и `IvanIvanov@mail.ru`.
Снизу диалог остался пуст потому что `IvanIvanov@mail.ru` и `JohnDoe@gmail.com` не общались. 